<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>H·ªçc Ti·∫øng Anh L·ªõp 12 - Unit 5: Urbanization</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        
        :root { --app-height: 100%; }

        body { 
            font-family: 'Inter', sans-serif; 
            background-image: url('https://img.freepik.com/free-vector/flat-design-english-school-background_23-2149487419.jpg?w=2000');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            overflow-x: hidden;
        }

        .glass-morphism {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }

        .choice-btn { touch-action: manipulation; -webkit-tap-highlight-color: transparent; }

        .correct { 
            background-color: #10b981 !important; 
            color: white !important; 
            border-color: #059669 !important;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            animation: pulse-green 0.3s ease-in-out;
        }

        .incorrect { 
            background-color: #ef4444 !important; 
            color: white !important; 
            border-color: #dc2626 !important;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
            animation: shake 0.3s ease-in-out;
        }

        @keyframes pulse-green {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-fadeIn { animation: fadeIn 0.4s ease-out forwards; }

        #leaderboard-list::-webkit-scrollbar { width: 4px; }
        #leaderboard-list::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .uppercase-input { text-transform: uppercase; }

        @media (max-width: 480px) {
            h1 { font-size: 1.5rem !important; }
            h2#word-display { font-size: 2rem !important; }
            #options-grid { grid-template-columns: 1fr !important; }
        }
    </style>
</head>
<body class="p-3 sm:p-6 md:p-8">

    <!-- Audio Elements -->
    <audio id="audio-correct" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3" type="audio/mpeg">
    </audio>
    <audio id="audio-incorrect" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/2003/2003-preview.mp3" type="audio/mpeg">
    </audio>

    <div class="w-full max-w-xl mx-auto flex flex-col items-center">
        
        <!-- M√†n h√¨nh Gi·ªõi thi·ªáu -->
        <div id="start-screen" class="w-full glass-morphism rounded-[2rem] shadow-2xl p-6 sm:p-10 text-center animate-fadeIn">
            <h1 class="text-2xl sm:text-3xl font-black text-indigo-800 mb-6 uppercase tracking-tighter leading-tight">Luy·ªán T·∫≠p Gi·ªõi T·ª´<br><span class="text-indigo-600 text-lg uppercase">Unit 5: Urbanization</span></h1>
            
            <div class="space-y-4 mb-8 text-left bg-white/60 p-5 rounded-2xl border border-indigo-100 shadow-inner">
                <h3 class="font-bold text-slate-800 border-b border-indigo-100 pb-2 flex items-center gap-2">C√°ch t√≠nh ƒëi·ªÉm:</h3>
                <ul class="space-y-3 text-slate-700 text-sm sm:text-base">
                    <li class="flex items-center gap-3">
                        <span class="w-6 h-6 flex-shrink-0 bg-green-100 text-green-600 rounded-full flex items-center justify-center font-bold">‚úì</span> 
                        <span>ƒê√∫ng: <strong class="text-green-600">+2 ƒëi·ªÉm</strong></span>
                    </li>
                    <li class="flex items-center gap-3">
                        <span class="w-6 h-6 flex-shrink-0 bg-red-100 text-red-600 rounded-full flex items-center justify-center font-bold">‚úï</span> 
                        <span>Sai: <strong class="text-red-600">-1 ƒëi·ªÉm</strong></span>
                    </li>
                    <li class="flex items-center gap-3">
                        <span class="w-6 h-6 flex-shrink-0 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center font-bold">üïí</span> 
                        <span>Th·ªùi gian: <strong>7 ph√∫t</strong></span>
                    </li>
                </ul>
            </div>
            
            <button id="btn-start" disabled onclick="startGame()" class="w-full bg-slate-400 text-white py-4 sm:py-5 rounded-2xl font-black text-lg sm:text-xl transition transform active:scale-[0.98] shadow-xl uppercase tracking-widest">
                ƒêANG K·∫æT N·ªêI...
            </button>
        </div>

        <!-- Dashboard Th√¥ng tin -->
        <div id="stats-panel" class="hidden w-full glass-morphism rounded-3xl shadow-xl p-4 sm:p-6 mb-4 animate-fadeIn">
            <div class="flex justify-between items-center">
                <div class="flex flex-col">
                    <span class="text-[10px] uppercase font-bold text-slate-400">Th·ªùi gian</span>
                    <span id="timer" class="text-xl sm:text-2xl font-black text-red-600 tabular-nums">07:00</span>
                </div>
                <div class="flex flex-col items-end">
                    <span class="text-[10px] uppercase font-bold text-slate-400">ƒêi·ªÉm s·ªë</span>
                    <span id="score" class="text-xl sm:text-2xl font-black text-indigo-700 tabular-nums">0</span>
                </div>
            </div>
            <div class="w-full bg-slate-200 rounded-full h-2 sm:h-3 mt-4 overflow-hidden shadow-inner">
                <div id="progress" class="bg-indigo-600 h-full transition-all duration-700 ease-out" style="width: 0%"></div>
            </div>
        </div>

        <!-- V√πng C√¢u H·ªèi -->
        <div id="game-container" class="hidden w-full glass-morphism rounded-[2rem] shadow-2xl p-6 sm:p-10 border border-white/50 animate-fadeIn">
            <div id="question-box" class="text-center">
                <p class="text-indigo-400 text-[10px] sm:text-xs font-bold uppercase tracking-widest mb-3">Ch·ªçn gi·ªõi t·ª´ ph√π h·ª£p</p>
                <h2 id="word-display" class="text-3xl sm:text-4xl font-black mb-2 text-slate-800 break-words leading-tight">...</h2>
                <p id="meaning-display" class="text-lg sm:text-xl text-indigo-500 italic mb-8 font-medium px-2">...</p>
                <div id="options-grid" class="grid grid-cols-2 gap-3 sm:gap-4"></div>
            </div>
        </div>

        <!-- M√†n h√¨nh k·∫øt th√∫c -->
        <div id="result-screen" class="hidden w-full glass-morphism rounded-[2rem] shadow-2xl p-6 sm:p-10 animate-fadeIn">
            <div class="text-center">
                <div class="inline-block p-4 bg-indigo-50 rounded-full mb-4">
                    <span class="text-4xl">üéì</span>
                </div>
                <h2 class="text-2xl sm:text-3xl font-black text-slate-800 mb-1">K·∫øt qu·∫£ luy·ªán t·∫≠p</h2>
                <p class="text-indigo-600 font-black text-5xl sm:text-6xl my-6" id="final-score-display">0</p>
                
                <div class="grid grid-cols-2 gap-3 sm:gap-4 mb-8">
                    <div class="bg-emerald-50 p-4 rounded-2xl border border-emerald-100">
                        <p class="text-[10px] text-emerald-600 font-bold uppercase mb-1">ƒê√∫ng</p>
                        <p class="text-2xl font-black text-emerald-700" id="correct-count">0</p>
                    </div>
                    <div class="bg-rose-50 p-4 rounded-2xl border border-rose-100">
                        <p class="text-[10px] text-rose-600 font-bold uppercase mb-1">Sai</p>
                        <p class="text-2xl font-black text-rose-700" id="incorrect-count">0</p>
                    </div>
                </div>

                <div id="mistakes-container" class="hidden text-left bg-orange-50 p-5 rounded-2xl border border-orange-100 mb-8">
                    <p class="text-orange-700 font-bold text-sm mb-3 flex items-center gap-2">‚ö†Ô∏è C·∫ßn √¥n t·∫≠p l·∫°i:</p>
                    <ul id="mistakes-list" class="text-sm text-slate-700 space-y-2"></ul>
                </div>

                <div id="leaderboard-prompt" class="space-y-3">
                    <p class="text-slate-500 text-sm">B·∫°n mu·ªën l∆∞u ƒëi·ªÉm v√†o B·∫£ng x·∫øp h·∫°ng th·∫ø gi·ªõi?</p>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <button onclick="toggleSaveSection(true)" class="flex-1 bg-indigo-600 text-white py-4 rounded-xl font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-100 transition active:scale-95">L∆∞u ƒëi·ªÉm & Xem BXH</button>
                        <button onclick="location.reload()" class="flex-1 bg-slate-200 text-slate-700 py-4 rounded-xl font-bold hover:bg-slate-300 transition active:scale-95">Ch∆°i l·∫°i</button>
                    </div>
                </div>

                <div id="save-score-section" class="hidden text-left bg-indigo-50 p-6 rounded-2xl border border-indigo-100">
                    <div class="flex flex-col gap-4">
                        <div>
                            <label class="text-[10px] font-bold text-indigo-400 uppercase ml-1">H·ªç v√† t√™n</label>
                            <input type="text" id="studentName" placeholder="NH·∫¨P T√äN..." 
                                oninput="this.value = this.value.toUpperCase()"
                                class="w-full px-4 py-3 rounded-xl border border-indigo-200 focus:ring-2 focus:ring-indigo-500 outline-none mt-1 font-bold uppercase">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-indigo-400 uppercase ml-1">L·ªõp h·ªçc</label>
                            <input type="text" id="studentClass" placeholder="V√ç D·ª§: 12A1..." 
                                oninput="this.value = this.value.toUpperCase()"
                                class="w-full px-4 py-3 rounded-xl border border-indigo-200 focus:ring-2 focus:ring-indigo-500 outline-none mt-1 font-bold uppercase">
                        </div>
                        <button onclick="saveResult()" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200 mt-2">G·ª¨I ƒêI·ªÇM L√äN H·ªÜ TH·ªêNG</button>
                    </div>
                </div>

                <div id="leaderboard" class="hidden mt-8 text-left animate-fadeIn">
                    <h3 class="font-black text-slate-800 mb-4 flex items-center gap-2 uppercase tracking-wider text-sm">üèÜ BXH TO√ÄN TR∆Ø·ªúNG (TOP 15)</h3>
                    <div id="leaderboard-list" class="space-y-2 max-h-[40vh] overflow-y-auto pr-1"></div>
                    <button onclick="location.reload()" class="w-full mt-6 bg-slate-800 text-white py-4 rounded-2xl font-bold hover:bg-black transition active:scale-95">V·ªÄ M√ÄN H√åNH CH√çNH</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, limit, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let currentUser = null;

        // Audio Helper
        const playSound = (id) => {
            const audio = document.getElementById(id);
            if (audio) {
                audio.currentTime = 0; // Reset to start
                audio.play().catch(e => console.log("Audio play blocked by browser. Interact with page first."));
            }
        };

        // Auth initialization
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                console.error("Auth error:", err);
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                const startBtn = document.getElementById('btn-start');
                startBtn.disabled = false;
                startBtn.innerText = "B·∫ÆT ƒê·∫¶U H·ªåC";
                startBtn.className = "w-full bg-indigo-600 text-white py-4 sm:py-5 rounded-2xl font-black text-lg sm:text-xl hover:bg-indigo-700 transition transform active:scale-[0.98] shadow-xl shadow-indigo-200 uppercase tracking-widest";
            }
        });

        initAuth();

        // Game Logic & Data
        const wordBank = [
            { word: "ban... ", prep: "from", meaning: "c·∫•m l√†m ƒëi·ªÅu g√¨ ƒë√≥" },
            { word: "benefit ", prep: "from", meaning: "c√≥ l·ª£i t·ª´ th·ª© g√¨ ƒë√≥" },
            { word: "believe ", prep: "in", meaning: "tin v√†o" },
            { word: "specialize ", prep: "in", meaning: "chuy√™n v·ªÅ" },
            { word: "accuse... ", prep: "of", meaning: "bu·ªôc t·ªôi v√¨ ƒëi·ªÅu g√¨" },
            { word: "remind... ", prep: "of", meaning: "nh·∫Øc nh·ªü v·ªÅ ƒëi·ªÅu g√¨" },
            { word: "agree ", prep: "on", meaning: "ƒë·ªìng √Ω v·ªÅ ƒëi·ªÅu g√¨" },
            { word: "rely ", prep: "on", meaning: "d·ª±a v√†o" },
            { word: "belong ", prep: "to", meaning: "thu·ªôc v·ªÅ" },
            { word: "object ", prep: "to", meaning: "ph·∫£n ƒë·ªëi" },
            { word: "angry ", prep: "with", meaning: "t·ª©c gi·∫≠n v·ªõi ai" },
            { word: "satisfied ", prep: "with", meaning: "h√†i l√≤ng v·ªõi" },
            { word: "famous ", prep: "for", meaning: "n·ªïi ti·∫øng v·ªÅ" },
            { word: "apply ", prep: "for", meaning: "n·ªôp ƒë∆°n xin (vi·ªác...)" },
            { word: "proud ", prep: "of", meaning: "t·ª± h√†o v·ªÅ" },
            { word: "anxious ", prep: "about", meaning: "lo l·∫Øng v·ªÅ" },
            { word: "succeed ", prep: "in", meaning: "th√†nh c√¥ng v·ªÅ ƒëi·ªÅu g√¨" },
            { word: "protect... ", prep: "against", meaning: "b·∫£o v·ªá kh·ªèi ƒëi·ªÅu g√¨" },
            { word: "good ", prep: "at", meaning: "gi·ªèi v·ªÅ vi·ªác g√¨" },
            { word: "by ", prep: "accident", meaning: "t√¨nh c·ªù, ng·∫´u nhi√™n" },
            { word: "at ", prep: "once", meaning: "ngay l·∫≠p t·ª©c" },
            { word: "solution ", prep: "to", meaning: "gi·∫£i ph√°p cho" },
            { word: "independent ", prep: "of", meaning: "ƒë·ªôc l·∫≠p, kh√¥ng l·ªá thu·ªôc" },
            { word: "look forward ", prep: "to", meaning: "mong ƒë·ª£i ƒëi·ªÅu g√¨ ƒë√≥" },
            { word: "prevent... ", prep: "from", meaning: "ngƒÉn c·∫£n kh·ªèi ƒëi·ªÅu g√¨" },
            { word: "interested ", prep: "in", meaning: "quan t√¢m ƒë·∫øn" },
            { word: "participate ", prep: "in", meaning: "tham gia v√†o" },
            { word: "aware ", prep: "of", meaning: "nh·∫≠n th·ª©c v·ªÅ" },
            { word: "capable ", prep: "of", meaning: "c√≥ kh·∫£ nƒÉng l√†m g√¨" },
            { word: "similar ", prep: "to", meaning: "t∆∞∆°ng t·ª± v·ªõi" },
            { word: "accustomed ", prep: "to", meaning: "quen v·ªõi vi·ªác g√¨" },
            { word: "responsible ", prep: "for", meaning: "ch·ªãu tr√°ch nhi·ªám cho" },
            { word: "reason ", prep: "for", meaning: "l√Ω do cho" },
            { word: "concentrate ", prep: "on", meaning: "t·∫≠p trung v√†o" },
            { word: "insist ", prep: "on", meaning: "khƒÉng khƒÉng l√†m g√¨" },
            { word: "graduate ", prep: "from", meaning: "t·ªët nghi·ªáp t·ª´" },
            { word: "suffer ", prep: "from", meaning: "ch·ªãu ƒë·ª±ng ƒëi·ªÅu g√¨" },
            { word: "result ", prep: "in", meaning: "d·∫´n ƒë·∫øn k·∫øt qu·∫£" },
            { word: "persist ", prep: "in", meaning: "ki√™n tr√¨ l√†m g√¨" },
            { word: "confide... ", prep: "in", meaning: "tin t∆∞·ªüng k·ªÉ cho ai" },
            { word: "tired ", prep: "of", meaning: "m·ªát m·ªèi v√¨ vi·ªác g√¨" },
            { word: "afraid ", prep: "of", meaning: "s·ª£ h√£i ƒëi·ªÅu g√¨" },
            { word: "approve... ", prep: "of", meaning: "t√°n th√†nh ƒëi·ªÅu g√¨" },
            { word: "depend ", prep: "on", meaning: "ph·ª• thu·ªôc v√†o" },
            { word: "congratulate... ", prep: "on", meaning: "ch√∫c m·ª´ng v√¨ ƒëi·ªÅu g√¨" },
            { word: "addicted ", prep: "to", meaning: "nghi·ªán ƒëi·ªÅu g√¨" },
            { word: "dedicated ", prep: "to", meaning: "t·∫≠n t·ª•y v·ªõi" },
            { word: "react... ", prep: "to", meaning: "ph·∫£n ·ª©ng v·ªõi" },
            { word: "bored ", prep: "with", meaning: "ch√°n n·∫£n v·ªõi" },
            { word: "familiar ", prep: "with", meaning: "quen thu·ªôc v·ªõi" },
            { word: "ready ", prep: "for", meaning: "s·∫µn s√†ng cho" },
            { word: "known ", prep: "for", meaning: "ƒë∆∞·ª£c bi·∫øt ƒë·∫øn v√¨" },
            { word: "care ", prep: "about", meaning: "quan t√¢m v·ªÅ" },
            { word: "complain ", prep: "about", meaning: "ph√†n n√†n v·ªÅ" },
            { word: "amazed ", prep: "at", meaning: "kinh ng·∫°c v·ªÅ" },
            { word: "aim ", prep: "at", meaning: "nh·∫Øm v√†o" },
            { word: "warn... ", prep: "against", meaning: "c·∫£nh b√°o ch·ªëng l·∫°i" }
        ];

        const prepositions = ["from", "in", "of", "on", "to", "with", "for", "about", "at", "against"];
        
        let score = 0;
        let correctCount = 0;
        let incorrectCount = 0;
        let timeLeft = 420; 
        let activeWords = []; 
        let currentWord = null;
        let gameActive = false;
        let canAnswer = true;
        let mistakeTracker = {};

        window.startGame = () => {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('stats-panel').classList.remove('hidden');
            document.getElementById('game-container').classList.remove('hidden');
            gameActive = true;
            initGame();
        };

        const initGame = () => {
            let shuffled = [...wordBank].sort(() => 0.5 - Math.random());
            activeWords = shuffled.slice(0, 20).map(item => ({...item, count: 0}));
            updateScoreDisplay();
            nextQuestion();
            startTimer();
        };

        const nextQuestion = () => {
            if (!gameActive) return;
            canAnswer = true;
            currentWord = activeWords[Math.floor(Math.random() * activeWords.length)];
            document.getElementById('word-display').innerText = currentWord.word;
            document.getElementById('meaning-display').innerText = `(${currentWord.meaning})`;
            generateOptions(currentWord.prep);
        };

        const generateOptions = (correctPrep) => {
            const grid = document.getElementById('options-grid');
            grid.innerHTML = '';
            let choices = [...prepositions.filter(p => p !== correctPrep).sort(() => 0.5 - Math.random()).slice(0, 3), correctPrep].sort(() => 0.5 - Math.random());
            
            choices.forEach(choice => {
                const btn = document.createElement('button');
                btn.className = "choice-btn py-4 sm:py-5 px-2 text-lg sm:text-xl font-black border-2 border-indigo-50 rounded-2xl transition-all active:scale-95 bg-white text-slate-700 shadow-sm hover:border-indigo-200 hover:bg-indigo-50/50";
                btn.innerText = choice;
                btn.onclick = () => checkAnswer(choice, btn);
                grid.appendChild(btn);
            });
        };

        const checkAnswer = (choice, btn) => {
            if (!gameActive || !canAnswer) return;
            canAnswer = false;

            if (choice === currentWord.prep) {
                playSound('audio-correct');
                score += 2;
                correctCount++;
                currentWord.count += 1;
                btn.classList.add('correct');
                if (currentWord.count >= 3) replaceWord(currentWord);
            } else {
                playSound('audio-incorrect');
                score = Math.max(0, score - 1);
                incorrectCount++;
                currentWord.count = 0; 
                btn.classList.add('incorrect');
                
                const wordKey = `${currentWord.word} [${currentWord.prep}]`;
                mistakeTracker[wordKey] = (mistakeTracker[wordKey] || 0) + 1;

                Array.from(document.querySelectorAll('#options-grid button')).forEach(b => {
                    if (b.innerText === currentWord.prep) b.classList.add('correct');
                });
            }
            updateScoreDisplay();
            setTimeout(nextQuestion, 700);
        };

        const replaceWord = (wordToReplace) => {
            const index = activeWords.indexOf(wordToReplace);
            const currentActiveWordsText = activeWords.map(w => w.word);
            const availableWords = wordBank.filter(w => !currentActiveWordsText.includes(w.word));
            if (availableWords.length > 0) {
                const newWord = availableWords[Math.floor(Math.random() * availableWords.length)];
                activeWords[index] = {...newWord, count: 0};
            }
        };

        const updateScoreDisplay = () => {
            document.getElementById('score').innerText = score;
            let totalProgress = activeWords.reduce((sum, w) => sum + w.count, 0);
            document.getElementById('progress').style.width = Math.min((totalProgress / 60) * 100, 100) + "%";
        };

        const startTimer = () => {
            const interval = setInterval(() => {
                if (!gameActive) { clearInterval(interval); return; }
                let mins = Math.floor(timeLeft / 60);
                let secs = timeLeft % 60;
                document.getElementById('timer').innerText = `${mins < 10 ? '0' : ''}${mins}:${secs < 10 ? '0' : ''}${secs}`;
                if (timeLeft <= 0) { clearInterval(interval); endGame(); }
                timeLeft--;
            }, 1000);
        };

        const endGame = () => {
            gameActive = false;
            document.getElementById('stats-panel').classList.add('hidden');
            document.getElementById('game-container').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            
            document.getElementById('final-score-display').innerText = score;
            document.getElementById('correct-count').innerText = correctCount;
            document.getElementById('incorrect-count').innerText = incorrectCount;

            const mistakesList = document.getElementById('mistakes-list');
            const sortedMistakes = Object.entries(mistakeTracker).sort((a, b) => b[1] - a[1]).slice(0, 5);

            if (sortedMistakes.length > 0) {
                document.getElementById('mistakes-container').classList.remove('hidden');
                mistakesList.innerHTML = sortedMistakes.map(([word, count]) => `
                    <li class="flex justify-between items-center border-b border-orange-100 pb-1">
                        <span class="font-medium">${word}</span>
                        <span class="bg-orange-200 text-orange-800 px-2 py-0.5 rounded-lg font-black text-[10px]">${count} sai</span>
                    </li>
                `).join('');
            }
        };

        window.toggleSaveSection = (show) => {
            document.getElementById('leaderboard-prompt').classList.add('hidden');
            if (show) document.getElementById('save-score-section').classList.remove('hidden');
        };

        // FIRESTORE OPERATIONS
        window.saveResult = async () => {
            if (!currentUser) {
                alert("L·ªói k·∫øt n·ªëi m√°y ch·ªß. Vui l√≤ng t·∫£i l·∫°i trang.");
                return;
            }

            const name = document.getElementById('studentName').value.trim().toUpperCase();
            const sClass = document.getElementById('studentClass').value.trim().toUpperCase();
            
            if (!name || !sClass) { alert("B·∫°n ch∆∞a nh·∫≠p ƒë·ªß th√¥ng tin!"); return; }

            const submitBtn = document.querySelector('#save-score-section button');
            submitBtn.disabled = true;
            submitBtn.innerText = "ƒêANG G·ª¨I...";

            try {
                const publicCollection = collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
                await addDoc(publicCollection, {
                    uid: currentUser.uid,
                    name: name,
                    class: sClass,
                    score: score,
                    timestamp: new Date().getTime()
                });

                document.getElementById('save-score-section').classList.add('hidden');
                showLeaderboard();
            } catch (err) {
                console.error("Save error:", err);
                alert("Kh√¥ng th·ªÉ l∆∞u ƒëi·ªÉm. Th·ª≠ l·∫°i sau!");
                submitBtn.disabled = false;
                submitBtn.innerText = "G·ª¨I ƒêI·ªÇM L√äN H·ªÜ TH·ªêNG";
            }
        };

        const showLeaderboard = () => {
            if (!currentUser) return;

            document.getElementById('leaderboard').classList.remove('hidden');
            const list = document.getElementById('leaderboard-list');
            list.innerHTML = '<p class="text-center py-4 text-slate-400 animate-pulse">ƒêang t·∫£i b·∫£ng x·∫øp h·∫°ng...</p>';

            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard'));
            
            onSnapshot(q, (snapshot) => {
                let data = [];
                snapshot.forEach(doc => data.push(doc.data()));
                data.sort((a, b) => b.score - a.score);
                const top15 = data.slice(0, 15);

                list.innerHTML = top15.length ? top15.map((entry, i) => `
                    <div class="flex justify-between items-center p-4 ${entry.uid === currentUser.uid ? 'bg-indigo-600 text-white shadow-indigo-200' : 'bg-white text-slate-800'} rounded-2xl border border-indigo-50 shadow-sm animate-fadeIn">
                        <div class="flex items-center gap-3">
                            <span class="w-8 h-8 flex items-center justify-center ${i < 3 && entry.uid !== currentUser.uid ? 'bg-yellow-400 text-white' : (entry.uid === currentUser.uid ? 'bg-white/20' : 'bg-indigo-50 text-indigo-400')} rounded-xl text-sm font-black">${i + 1}</span>
                            <div>
                                <p class="font-black leading-tight">${entry.name}</p>
                                <p class="text-[10px] ${entry.uid === currentUser.uid ? 'text-indigo-200' : 'text-slate-400'} font-bold uppercase tracking-tighter">${entry.class}</p>
                            </div>
                        </div>
                        <div class="flex flex-col items-end">
                            <span class="text-xl font-black">${entry.score}</span>
                            <span class="text-[8px] opacity-60">${entry.uid}</span>
                        </div>
                    </div>
                `).join('') : '<p class="text-center py-4 text-slate-400 italic">Ch∆∞a c√≥ ai ghi danh.</p>';
            }, (error) => {
                console.error("Snapshot error:", error);
                list.innerHTML = '<p class="text-center text-red-500 p-4">L·ªói t·∫£i d·ªØ li·ªáu!</p>';
            });
        };
    </script>
</body>
</html>
